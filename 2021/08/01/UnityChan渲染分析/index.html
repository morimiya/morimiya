<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/morimiya/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/morimiya/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/morimiya/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/morimiya/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/morimiya/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/morimiya/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/morimiya/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/morimiya/atom.xml" title="MoriMiya" type="application/atom+xml">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/morimiya/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/morimiya/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/morimiya/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/morimiya/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/morimiya/css/page.css">
<link rel="stylesheet" type="text/css" href="/morimiya/css/post.css">

    <link rel="stylesheet" type="text/css" href="/morimiya/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/morimiya/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/morimiya/css/lightgallery.min.css">
    <script type="text/javascript" src="/morimiya/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/util.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/clipboard.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/morimiya/js/lg-zoom.min.js"></script>
    
    <script defer src="/morimiya/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/morimiya/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/morimiya/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    
    
    <script defer type="text/javascript" src="/morimiya/js/index.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var cb = null;
      var els = $(".post figure.highlight");
      if (els.length) {
        // Enabled Hexo highlight line number.
        $(els).each(function (i, e) {
          $(e).before("<button class=\"copy button\">复制</button>");
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              // nextElementSibling is figure,highlight.
              // And following is the sequence of Hexo's internal
              // highlight layout with line number.
              return trigger.nextElementSibling.firstChild.firstChild.firstChild.lastChild.firstChild.firstChild;
          }
        });
      } else {
        // Disabled Hexo highlight line number.
        els = $(".post pre code");
        $(els).each(function (i, e) {
          // Add button before pre, not code.
          $(e).parent().before("<button class=\"copy button\">复制</button>");
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              // nextElementSibling is figure,highlight.
              // And following is the sequence of Hexo's internal
              // highlight layout without line number.
              return trigger.nextElementSibling.firstChild;
          }
        });
      }
      cb.on("success", function (e) {
        e.clearSelection();
        var trigger = e.trigger;
        // Change button text as a user tip.
        trigger.innerHTML = "已复制";
        $(trigger).addClass("copied");
        // Change button text back;
        setTimeout(function () {
          trigger.innerHTML = "复制";
          $(trigger).removeClass("copied");
        }, 1500);
      });
    });
    </script>
    
    <script defer type="text/javascript" src="/morimiya/js/custom.js"></script>
    <title>UnityChan渲染分析 | MoriMiya - Don't you want to be alive before you die?</title>
  </head>
  <body itemscope="" itemtype="http://schema.org/WebPage" lang="zh_CN" data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/morimiya/">MoriMiya</a></h1>
        <h2 class="subtitle">Don't you want to be alive before you die?</h2>
      </div>
      
      <div class="logo">
        <img src="/morimiya/images/logo.png" alt="logo">
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/morimiya/"><i class="fas fa-home"></i><span class="menu-text">首页</span></a></li>
        
        <li role="menuitem"><a href="/morimiya/archives/"><i class="fas fa-archive"></i><span class="menu-text">归档</span></a></li>
        
        <li role="menuitem"><a href="/morimiya/categories/"><i class="fas fa-th-list"></i><span class="menu-text">分类</span></a></li>
        
        <li role="menuitem"><a href="/morimiya/tags/"><i class="fas fa-tags"></i><span class="menu-text">标签</span></a></li>
        
        <li role="menuitem"><a href="/morimiya/about/"><i class="fas fa-user-edit"></i><span class="menu-text">关于</span></a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="page">
  
  <article class="article post card animate" itemscope="" itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="https://morimiya.github.io/morimiya/2021/08/01/UnityChan渲染分析/">
      <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
       <meta itemprop="name" content="MoriMiya">
       <meta itemprop="description" content="">
       <meta itemprop="image" content="/morimiya/images/myavatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="MoriMiya">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">UnityChan渲染分析</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2021-08-01T17:36:28+08:00">2021-08-01 17:36:28</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/morimiya/categories/游戏开发/" itemprop="url" rel="index"><span itemprop="name">游戏开发</span></a></span><i class="fas fa-angle-right"></i><span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/morimiya/categories/游戏开发/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <blockquote>
<p>使用Unity版本为：2019.4.10f1。<br>-<br>使用素材地址：<br><a href="https://github.com/unity3d-jp/UnityChanToonShaderVer2_Project" target="_blank" rel="noopener">https://github.com/unity3d-jp/UnityChanToonShaderVer2_Project</a><br>Unity商店unity-chan!<br>-<br>shader代码源地址：于Unity商店中搜索unity-chan!导入，目录为:unity-chan!/Unity-chan! Model/Art/UnityChanShader/Shader/Unitychan_chara_fuku.shader<br>-<br>最终效果：<img src="/morimiya/2021/08/01/UnityChan渲染分析/最终结果.png" style="width: 12em;" alt="效果展示"></p>
<p><img src="/morimiya/2021/08/01/UnityChan渲染分析/unity-chan.png" style="width: 24em;" alt="unity-chan"><br><a id="more"></a></p>
</blockquote>
<h2 id="UnityChan渲染分析"><a href="#UnityChan渲染分析" class="headerlink" title="UnityChan渲染分析"></a>UnityChan渲染分析</h2><p>Author: MoriMiya</p>
<h3 id="Unitychan-chara-fuku模块"><a href="#Unitychan-chara-fuku模块" class="headerlink" title="Unitychan_chara_fuku模块"></a>Unitychan_chara_fuku模块</h3><ol>
<li><p>Properties中有以下类型变量，可以看出该shader渲染将会包含：</p>
<ol>
<li>普通纹理漫反射颜色，配合递减贴图将会对颜色做一定的亮度梯度区分。</li>
<li>有边缘光贴图，表示模型边缘将会有高光。</li>
<li>有描边宽度设置，表示模型会有描边。</li>
<li>其他剩余的变量都是常规的光照会使用到的数据，值得注意的是环境贴图是一张2D贴图，而不是MapCube。<figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++">Properties<br>&#123;<br>    _Color (<span class="hljs-string">"Main Color"</span>, Color) = (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    _ShadowColor (<span class="hljs-string">"Shadow Color"</span>, Color) = (<span class="hljs-number">0.8</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// 阴影颜色。</span><br>    _SpecularPower (<span class="hljs-string">"Specular Power"</span>, Float) = <span class="hljs-number">20</span>           <span class="hljs-comment">// 高光乘方次数。</span><br>    _EdgeThickness (<span class="hljs-string">"Outline Thickness"</span>, Float) = <span class="hljs-number">1</span>         <span class="hljs-comment">// 描边宽度。</span><br><br>    _MainTex (<span class="hljs-string">"Diffuse"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> &#123;&#125;                   <span class="hljs-comment">// 主纹理。</span><br>    _FalloffSampler (<span class="hljs-string">"Falloff Control"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> &#123;&#125;    <span class="hljs-comment">// 递减贴图。</span><br>    _RimLightSampler (<span class="hljs-string">"RimLight Control"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> &#123;&#125;  <span class="hljs-comment">// 边缘光贴图。</span><br>    _SpecularReflectionSampler (<span class="hljs-string">"Specular / Reflection Mask"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> &#123;&#125;  <span class="hljs-comment">// 高光贴图。</span><br>    _EnvMapSampler (<span class="hljs-string">"Environment Map"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">""</span> &#123;&#125;          <span class="hljs-comment">// 环境贴图。</span><br>    _NormalMapSampler (<span class="hljs-string">"Normal Map"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">""</span> &#123;&#125;            <span class="hljs-comment">// 法线贴图。</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>接下来看它的Pass里做了什么：</p>
<ol>
<li>第一个Pass：<ul>
<li>引入了常规CG内置模块和AutoLight内置模块。</li>
<li>还加入了CharaMain.cg模块。</li>
</ul>
</li>
<li>第二个Pass：<ul>
<li>深度剔除方式是正面剔除。</li>
<li>引入了常规UnityCG模块。</li>
<li>引入了CharaOutline.cg模块。</li>
</ul>
</li>
<li>第二个Pass不涉及光照计算，比较简单，先从该Pass进行分析。<figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c++">Pass<br>&#123;<br>    Cull Back<br>    ZTest LEqual<br>CGPROGRAM<br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> multi_compile_fwdbase</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> target 3.0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> vertex vert</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> fragment frag</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"UnityCG.cginc"</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"AutoLight.cginc"</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ENABLE_NORMAL_MAP</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"CharaMain.cg"</span></span><br>ENDCG<br>&#125;<br><br>Pass<br>&#123;<br>    Cull Front<br>    ZTest Less<br>CGPROGRAM<br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> target 3.0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> vertex vert</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> fragment frag</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"UnityCG.cginc"</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"CharaOutline.cg"</span></span><br>ENDCG<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h3 id="描边-Charaoutline-cg"><a href="#描边-Charaoutline-cg" class="headerlink" title="描边(Charaoutline.cg)"></a>描边(Charaoutline.cg)</h3><ul>
<li>第二个Pass中Charaoutline.cg做的事情便是给模型进行描边。</li>
<li><p>vertex代码：</p>
<figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Vertex shader</span><br><span class="hljs-function">v2f <span class="hljs-title">vert</span><span class="hljs-params">( appdata_base v )</span><br></span>&#123;<br>	v2f o;<br>	o.uv = TRANSFORM_TEX( v.texcoord.xy, _MainTex );<br><br>	half4 projSpacePos = UnityObjectToClipPos( v.vertex );<br>	half4 projSpaceNormal = normalize( UnityObjectToClipPos( half4( v.normal, <span class="hljs-number">0</span> ) ) );<br>	half4 scaledNormal = _EdgeThickness * INV_EDGE_THICKNESS_DIVISOR * projSpaceNormal; <span class="hljs-comment">// * projSpacePos.w;</span><br><br>	scaledNormal.z += <span class="hljs-number">0.00001</span>;<br>	o.pos = projSpacePos + scaledNormal;<br><br>	<span class="hljs-keyword">return</span> o;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>代码中做的事情是先计算出法线在透视矩阵空间下的方向，让模型坐标沿法线方向进行偏移。</p>
</li>
<li><p>这里的法线偏移值最终z值加了0.00001的值，是为了避免如眉毛等会被其他网格遮挡住的边缘的网格能够正常进行描边。</p>
</li>
<li><p>fragment代码：</p>
<figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++">// Fragment shader<br>float4 frag( v2f i ) : COLOR<br>&#123;<br>	float4_t diffuseMapColor = tex2D( _MainTex, i.uv );<br><br>	float_t maxChan = max( max( diffuseMapColor.r, diffuseMapColor.g ), diffuseMapColor.b );<br>	float4_t newMapColor = diffuseMapColor;<br><br>	maxChan -= ( 1.0 / 255.0 );<br>	float3_t lerpVals = saturate( ( newMapColor.rgb - float3( maxChan, maxChan, maxChan ) ) * 255.0 );<br>	newMapColor.rgb = lerp( SATURATION_FACTOR * newMapColor.rgb, newMapColor.rgb, lerpVals );<br><br>	return float4( BRIGHTNESS_FACTOR * newMapColor.rgb * diffuseMapColor.rgb, diffuseMapColor.a ) * _Color * _LightColor0;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>这里通过将纹理颜色与其最大通道值作差，选出哪些颜色通道是具有代表性的通道，通过saturate函数和lerp函数的配合，对于有代表性的通道，则让其显示纹理原来该通道的值，对于代表性不强的通道，则让其通道颜色乘SATURATION_FACTOR，让其值变得更小更加不突出，这些值存于newMapColor中。</p>
</li>
<li>最后将newMapColor于漫反射颜色相乘，在乘以亮度系数BRIGHTNESS_FACTOR，最后乘以_Color和光照颜色，得出描边颜色。</li>
<li><img src="/morimiya/2021/08/01/UnityChan渲染分析/仅漫反射贴图.png" style="width: 12em;" alt="效果展示"> <img src="/morimiya/2021/08/01/UnityChan渲染分析/漫反射贴图+描边.png" style="width: 12em;" alt="描边效果"></li>
</ul>
<h3 id="光照处理-CharaMain-cg"><a href="#光照处理-CharaMain-cg" class="headerlink" title="光照处理(CharaMain.cg)"></a>光照处理(CharaMain.cg)</h3><ul>
<li><p>vertex代码：</p>
<figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">v2f <span class="hljs-title">vert</span><span class="hljs-params">(appdata v)</span> </span>&#123;<br>	v2f f;<br>	f.pos = UnityObjectToClipPos(v.vertex);<br>	f.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;<br><br>	half4 worldPos = mul( unity_ObjectToWorld, v.vertex );<br>	f.eyeDir.xyz = normalize( _WorldSpaceCameraPos.xyz - worldPos.xyz ).xyz;<br>	f.lightDir = WorldSpaceLightDir( v.vertex );<br><br>	f.normal = normalize(UnityObjectToWorldDir(v.normal));<br>	f.tangent = normalize(UnityObjectToWorldDir(v.tangent));<br>	f.binormal = normalize(cross(f.normal, f.tangent));<br><br>    <span class="hljs-comment">// COMPUTE_LIGHT_COORDS(f) TRANSFER_SHADOW(f)</span><br>	TRANSFER_VERTEX_TO_FRAGMENT(f);		<span class="hljs-comment">// 计算世界空间顶点到光的方向，光源空间的顶点坐标。</span><br>	<span class="hljs-keyword">return</span> f;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>顶点着色计算了在世界坐标空间下的视线eyeDir方向，光照方向lightDir，以及TBN向量，方便后续进行切线计算。</p>
</li>
<li><p>TRANSFER_VERTEX_TO_FRAGMENT的实质是COMPUTE_LIGHT_COORDS(f) TRANSFER_SHADOW(f)，即计算世界空间顶点到光的方向，光源空间的顶点坐标（不屏幕空间的阴影方法下成立），具体看AutoLight.cginc实现。</p>
</li>
<li><p>fragment代码：</p>
</li>
<li>片段着色器代码内容较多，下面详细分块讲解。</li>
<li>这里所有的计算都基于世界空间坐标系计算，除了影子的计算得看情况。</li>
</ul>
<h4 id="漫反射颜色和法向量"><a href="#漫反射颜色和法向量" class="headerlink" title="漫反射颜色和法向量"></a>漫反射颜色和法向量</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">inline</span> fixed3 <span class="hljs-title">GetNormalFromMap</span><span class="hljs-params">(v2f input)</span> </span>&#123;<br>	fixed3 normalVec = normalize( tex2D( _NormalMapSampler, input.uv ).xyz * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span> );<br>	fixed3x3 localToWorldTranspose = fixed3x3(<br>		input.tangent,<br>		input.binormal,<br>		input.normal<br>	);<br><br>	normalVec = normalize( mul( normalVec, localToWorldTranspose ) );<br>	<span class="hljs-keyword">return</span> normalVec;<br>&#125;<br>float4 diffSamplerColor = tex2D(_MainTex, f.uv.xy);<br>float3 normalVec = GetNormalFromMap(f);<br></code></pre></td></tr></table></figure>
<ul>
<li>中规中矩得代码，采样贴图获得漫反射颜色，通过TBN矩阵将法线从切线空间转换至世界空间。</li>
</ul>
<h4 id="Falloff衰减色"><a href="#Falloff衰减色" class="headerlink" title="Falloff衰减色"></a>Falloff衰减色</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 衰减色（Falloff），根据法线与视线的夹角的cos值作为漫反射的衰减值；利用lookup贴图来将衰减值作明显的区间分段。</span><br><span class="hljs-keyword">float</span> normalDotEye = dot(normalVec, f.eyeDir.xyz);<br><span class="hljs-keyword">float</span> falloffU = clamp(<span class="hljs-number">1.0</span> - <span class="hljs-built_in">abs</span>(normalDotEye), <span class="hljs-number">0.02</span>, <span class="hljs-number">0.98</span>);<br>float4 falloffSamplerColor = FALLOFF_POWER * tex2D(_FalloffSampler, float2(falloffU, <span class="hljs-number">0.25</span>));	<span class="hljs-comment">// 将线性连续值得通过lookup贴图变成分段区间较为离散的值。</span><br>float3 shadowColor = diffSamplerColor.rgb * diffSamplerColor.rgb;	<span class="hljs-comment">// 暗色。</span><br>float3 combinedColor = lerp(diffSamplerColor.rgb, shadowColor, falloffSamplerColor.r);<br>combinedColor *= (<span class="hljs-number">1.0</span> + falloffSamplerColor.rgb * falloffSamplerColor.a);	<span class="hljs-comment">// 这里再混上边缘变白的颜色。</span><br></code></pre></td></tr></table></figure>
<ul>
<li>首先用1.0 - 法线与视线的夹角的cos值 得到一个falloffU得值，该值得特点是法线与视线同方向则为0，垂直则为1.0，即该值会越接近模型边缘越趋向于1.0。</li>
<li>使用falloffU在一张lookup贴图中进行采样来获得分段区间较为离散的值falloffSamplerColor。<img src="/morimiya/2021/08/01/UnityChan渲染分析/FO_CLOTH1.png" style="width: 6em;" alt="FalloffSampler"></li>
<li>通过falloffSamplerColor来确定颜色在暗色（原色的二次方）和原色间的过度值，从而计算出目标色combinedColor。</li>
<li>最后目标色再加上了falloffSamplerColor，让边缘会偏向白（亮）一些。</li>
<li>单纯的falloffColor：<img src="/morimiya/2021/08/01/UnityChan渲染分析/falloffColor.png" style="width: 12em;" alt="falloffColor"></li>
<li>边缘白色：<img src="/morimiya/2021/08/01/UnityChan渲染分析/边缘白色.png" style="width: 12em;" alt="边缘白色"></li>
<li>falloffColor+边缘白边：<img src="/morimiya/2021/08/01/UnityChan渲染分析/falloffColor+边缘白边.png" style="width: 12em;" alt="falloffColor+边缘白边"></li>
</ul>
<h4 id="Sepcular高光"><a href="#Sepcular高光" class="headerlink" title="Sepcular高光"></a>Sepcular高光</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Sepcular高光。</span><br><span class="hljs-comment">// 这里把视线eyeDir向量当作光照方向来计算Specular高光。</span><br>float4 reflectionMaskColor = tex2D(_SpecularReflectionSampler, f.uv.xy);<br><span class="hljs-keyword">float</span> specularDot = dot(normalVec, f.eyeDir.xyz);<br><span class="hljs-comment">// lit(NdotL, NdotH, m) N表示法向量；L表示入射光向量；H表示半角向量；m表示高光系数。</span><br><span class="hljs-comment">// 	Returns a lighting vector (ambient, diffuse, specular, 1)</span><br>float4 lighting = lit( normalDotEye, specularDot, _SpecularPower );<br><span class="hljs-comment">// saturate: Clamps x to the range [0, 1]</span><br>float3 specularColor = saturate(lighting.z) * reflectionMaskColor.rgb * diffSamplerColor.rgb;<br>combinedColor += specularColor;<br></code></pre></td></tr></table></figure>
<ul>
<li>这里把视线eyeDir向量当作光照方向来计算光照。</li>
<li>乘以高光反射贴图的颜色，让高光的颜色更加准确，我这里没有好的高光反射贴图，使用了一张漫反射贴图来替代。</li>
<li>高光颜色：<img src="/morimiya/2021/08/01/UnityChan渲染分析/specular颜色.png" style="width: 12em;" alt="specular颜色"></li>
<li>加上高光颜色效果：<img src="/morimiya/2021/08/01/UnityChan渲染分析/加上specular颜色.png" style="width: 12em;" alt="加上specular颜色"></li>
</ul>
<h4 id="Reflection环境反射"><a href="#Reflection环境反射" class="headerlink" title="Reflection环境反射"></a>Reflection环境反射</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Reflection</span><br><span class="hljs-function"><span class="hljs-keyword">inline</span> float3 <span class="hljs-title">GetOverlayColor</span><span class="hljs-params">( float3 inUpper, float3 inLower )</span> </span>&#123;<br>	float3 oneMinusLower = float3( <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span> ) - inLower;<br>	float3 valUnit = <span class="hljs-number">2.0</span> * oneMinusLower;<br>	float3 minValue = <span class="hljs-number">2.0</span> * inLower - float3( <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span> );		<span class="hljs-comment">// 需要保证：minValue + valUnit = float3(1.0)，因为这样即表示为minValue变纯白的过程。</span><br>	float3 greaterResult = inUpper * valUnit + minValue;			<span class="hljs-comment">// 通过inUpper来决定每个通道的增长valUnit值，结果会偏向于float3(1.0)。</span><br>	float3 lowerResult = <span class="hljs-number">2.0</span> * inLower * inUpper;					<span class="hljs-comment">// 这里没能看出套路，猜测是一个经验值，根据inUpper*inLower来决定最低值，*2为了让它不太暗。</span><br><br>	half3 lerpVals = round(inLower);								<span class="hljs-comment">// 类四舍五入取整，让lerp结果分割明显。</span><br>	<span class="hljs-keyword">return</span> lerp(lowerResult, greaterResult, lerpVals);<br>&#125;<br><br>float3 reflectVector = reflect( -f.eyeDir.xyz, normalVec ).xzy;		<span class="hljs-comment">// 把yz互换，边缘会更光亮点。</span><br>float2 sphereMapCoords = <span class="hljs-number">0.5</span> * ( float2( <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span> ) + reflectVector.xy );	<span class="hljs-comment">// 将坐标从[-1, 1] 映射到[0, 1]。</span><br>float3 reflectColor = tex2D( _EnvMapSampler, sphereMapCoords ).rgb;<br>reflectColor = GetOverlayColor( reflectColor, combinedColor );<br><br>combinedColor = lerp( combinedColor, reflectColor, reflectionMaskColor.a );<br>combinedColor *= _Color.rgb * _LightColor0.rgb;<br><span class="hljs-keyword">float</span> opacity = diffSamplerColor.a * _Color.a * _LightColor0.a;<br></code></pre></td></tr></table></figure>
<ul>
<li>这里在计算反射光向量的时候，把yz互换了，这样做回是的边缘更光亮些，对比效果如下。</li>
<li>reflect_xyz：<img src="/morimiya/2021/08/01/UnityChan渲染分析/reflect_xyz.png" style="width: 12em;" alt="reflect_xyz"></li>
<li>reflect_xzy：<img src="/morimiya/2021/08/01/UnityChan渲染分析/reflect_xzy.png" style="width: 12em;" alt="reflect_xzy"></li>
<li>然后这里从环境贴图采样只用到了xy值，不使用z值，采样器也不是Cube，这里与传统做法相比较省显存，算是一种取巧的方式。</li>
<li>在计算反射颜色的时候也做了一些有趣的处理，其相当于在求下面两图的一个混合效果，混合的方式则为根据至今计算的combinedColor每个通道的颜色值，如果&gt;0.5，则该通道用高亮色，否则使用暗色。</li>
<li>高亮色greaterResult和暗色lowerResult的定义都是一些取巧方式或经验值，具体可查看代码及我标注的注释。</li>
<li>lowerResult：<img src="/morimiya/2021/08/01/UnityChan渲染分析/lowerResult.png" style="width: 12em;" alt="lowerResult"></li>
<li>greaterResult：<img src="/morimiya/2021/08/01/UnityChan渲染分析/greaterResult.png" style="width: 12em;" alt="greaterResult"></li>
<li>由于我是用一张漫反射贴图替代高光反射贴图，reflectionMaskColor.a的值必然为1.0，会让结果显示为greaterResult，因此我实际代码中改为写0.5来获得一个还能看的效果。</li>
<li>效果图：<img src="/morimiya/2021/08/01/UnityChan渲染分析/加上reflection.png" style="width: 12em;" alt="加上reflection"></li>
</ul>
<h4 id="Cast-Shadow"><a href="#Cast-Shadow" class="headerlink" title="Cast Shadow"></a>Cast Shadow</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Cast shadows 这里目前没使用到。</span><br>shadowColor = _ShadowColor.rgb * combinedColor;<br><span class="hljs-keyword">float</span> attenuation = saturate( <span class="hljs-number">2.0</span> * LIGHT_ATTENUATION( f ) - <span class="hljs-number">1.0</span> );<br>combinedColor = lerp( shadowColor, combinedColor, attenuation );<br></code></pre></td></tr></table></figure>
<h4 id="Rimlight-边缘高光"><a href="#Rimlight-边缘高光" class="headerlink" title="Rimlight 边缘高光"></a>Rimlight 边缘高光</h4><figure class="hljs highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// Rimlight 边缘高光。</span><br><span class="hljs-keyword">float</span> rimlightDot = saturate( <span class="hljs-number">0.5</span> * ( dot( normalVec, f.lightDir ) + <span class="hljs-number">1.0</span> ) );<br><span class="hljs-comment">// float falloffU = clamp(1.0 - abs(normalDotEye), 0.02, 0.98);</span><br>falloffU = saturate( rimlightDot * falloffU );		<span class="hljs-comment">// (1.0-视线与法线的夹角)得出越是边缘值越大，*rimlightDot即与该处实际光照强度相乘，让暗处边缘光不会太亮。</span><br>falloffU = tex2D( _RimLightSampler, float2( falloffU, <span class="hljs-number">0.25f</span> ) ).r;<br>float3 lightColor = diffSamplerColor.rgb; <span class="hljs-comment">// * 2.0;</span><br>combinedColor += falloffU * lightColor;<br></code></pre></td></tr></table></figure>
<ul>
<li>(1.0-视线与法线的夹角)得出越是边缘值越大，*rimlightDot即与该处实际光照强度相乘，让暗处边缘光不会太亮。</li>
<li>边缘高光仅用falloffU：<img src="/morimiya/2021/08/01/UnityChan渲染分析/边缘高光_仅用falloffU.png" style="width: 12em;" alt="边缘高光_仅用falloffU"></li>
<li>边缘高光falloffUXrimlightDot：<img src="/morimiya/2021/08/01/UnityChan渲染分析/边缘高光_falloffUXrimlightDot.png" style="width: 12em;" alt="边缘高光_falloffUXrimlightDot"></li>
<li>也是在一张lookup贴图中获取离散的值得，让falloffU有较明显的分层。</li>
<li>最后加上边缘光颜色，获得下图效果。</li>
<li>最终结果：<img src="/morimiya/2021/08/01/UnityChan渲染分析/最终结果.png" style="width: 12em;" alt="最终结果"></li>
<li><img src="/morimiya/2021/08/01/UnityChan渲染分析/unity-chan.png" style="width: 24em;" alt="unity-chan"></li>
</ul>

    </main>
    <footer class="post-footer">
      
      <div class="post-tags">
        
        <a class="post-tag button" href="/morimiya/tags/Unity/" rel="tag"><i class="fas fa-tags"></i>Unity</a>
        
        <a class="post-tag button" href="/morimiya/tags/游戏开发/" rel="tag"><i class="fas fa-tags"></i>游戏开发</a>
        
      </div>
      
    </footer>
  </article>
  
  
  <nav class="page-nav">
    <div class="page-nav-next page-nav-item">
      
      <a href="/morimiya/2021/02/17/CocosCreator-合成大西瓜/" rel="next" title="CocosCreator-合成大西瓜"><i class="fas fa-angle-left"></i><span class="nav-title">CocosCreator-合成大西瓜</span></a>
      
    </div>
    <div class="page-nav-prev page-nav-item">
      
      <a href="/morimiya/2021/08/08/塞尔达风格卡通渲染/" rel="prev" title="塞尔达风格卡通渲染"><span class="nav-title">塞尔达风格卡通渲染</span><i class="fas fa-angle-right"></i></a>
      
    </div>
  </nav>
  
  
  

<div class="comments" id="comments">
  
  
  <div id="vcomments" class="vcomments"></div>
  <script defer src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script defer src="//unpkg.com/valine/dist/Valine.min.js"></script>
  <script type="text/javascript">
  $(document).ready(function () {
    new Valine({
      "el": "#vcomments",
      "appId": "g87PyVdDsH5EP8VCTtaGlIBo-gzGzoHsz",
      "appKey": "wboY6qvCvYXBESIQQOWkFzYq",
      "verify": "false",
      "notify": "false",
      "avatar": "mm",
      "meta": ["nick", "mail", "link"],
      "pageSize": 10,
      "lang": "zh-cn",
      "visitor": "false",
      "highlight": "true",
      "placeholder": "在这里说点什么……",
      "avatarForce": "false"
    });
  });
  </script>
  
  
</div>



  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/morimiya/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control">
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/morimiya/images/myavatar.png" alt="MoriMiya">
  
  <h1 class="author-name">MoriMiya</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    
    
    
    <div class="archives-count count-block">
      <div class="site-count-title">归档</div>
      <div><a href="/morimiya/archives/">35</a></div>
    </div>
    
    
    
    <div class="categories-count count-block">
      <div class="site-count-title">分类</div>
      <div><a href="/morimiya/categories/">30</a></div>
    </div>
    
    
    
    <div class="tags-count count-block">
      <div class="site-count-title">标签</div>
      <div><a href="/morimiya/tags/">29</a></div>
    </div>
    
    
    
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/morimiya/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
    
    
    <hr>
    <div class="post-toc sidebar-item" id="toc-div">
      <div><i class="fas fa-list-ol"></i>文章目录</div>
      <div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#UnityChan渲染分析"><span class="toc-text">UnityChan渲染分析</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Unitychan-chara-fuku模块"><span class="toc-text">Unitychan_chara_fuku模块</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#描边-Charaoutline-cg"><span class="toc-text">描边(Charaoutline.cg)</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#光照处理-CharaMain-cg"><span class="toc-text">光照处理(CharaMain.cg)</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#漫反射颜色和法向量"><span class="toc-text">漫反射颜色和法向量</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Falloff衰减色"><span class="toc-text">Falloff衰减色</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Sepcular高光"><span class="toc-text">Sepcular高光</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Reflection环境反射"><span class="toc-text">Reflection环境反射</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Cast-Shadow"><span class="toc-text">Cast Shadow</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Rimlight-边缘高光"><span class="toc-text">Rimlight 边缘高光</span></a></li></ol></li></ol></li></ol></div>
    </div>
    
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>社交链接<p></p></div>
      <ul>
        
        <li><i class="fab fa-github"></i><a href="https://github.com/morimiya" target="_blank">GitHub</a></li>
        
      </ul>
    </div>
    
    
    <hr>
    <div class="blogroll sidebar-item">
      <div><i class="fas fa-link"></i>友情链接</div>
      <ul>
        
        <li><i class="fas fa-link"></i><a href="https://github.com/" target="_blank">GitHub</a></li>
        
      </ul>
    </div>
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">MoriMiya</span><span class="year"><i class="far fa-copyright"></i>2018 - 2023</span>
        </div>
        
        <div class="busuanzi">
          <span id="busuanzi_container_site_pv"><i class="fas fa-eye" aria-label="站点点击量" aria-hidden="false"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user" aria-label="站点用户数" aria-hidden="false"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv" aria-label="页面点击量" aria-hidden="false"></span></span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
